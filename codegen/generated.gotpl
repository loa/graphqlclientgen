// Code generated by github.com/loa/graphqlclientgen, DO NOT EDIT.

package {{ .Config.Client.Package }}

import (
	"context"
	"encoding/json"
	"fmt"
	"strings"

    "github.com/loa/graphqlclientgen/graphqlclient"
    {{- range .Config.TypeMappings }}
        {{- if .Import }}
    {{ if .Alias }}{{ .Alias }} {{ end }}"{{ .Import }}"
        {{- end }}
    {{- end }}
)


type (
    // Client for graphqlclient
    Client struct {
		protoClient graphqlclient.ProtoClient
    }

{{ range $type := .Schema.Types }}
    // {{ $type.Name }} {{ stripPrefix $type.Description $type.Name }}
    {{ $type.Name | capitalize }} struct {
        {{- range $name, $field := $type.Fields }}
            // {{ $name | capitalize | initialism }} {{ stripPrefix $field.Description $name }}
            {{ $name | capitalize | initialism }} {{ if $field.List }}[]{{ end }}{{ if or (not $field.NonNull) (eq $field.Kind "OBJECT") }}*{{ end }}{{ $field.Type }} `json:"{{ $name }}"`
        {{- end }}
    }
{{ end }}
{{- range $type := .Schema.Types }}
{{- if not (eq $type.Kind "INPUT_OBJECT") }}
    {{ $type.Name | capitalize }}FieldScalar string
    {{ $type.Name | capitalize }}Field interface {
        {{ $type.Name | capitalize }}FieldGraphQL() string
    }
    {{ $type.Name | capitalize }}Fields []{{ $type.Name | capitalize }}Field

    {{- range $name, $field := $type.Fields }}
        {{- if eq $field.Kind "OBJECT" }}
    {{ $type.Name | capitalize }}Field{{ $name | capitalize | initialism }} []{{ $field.Type }}Field
        {{- end }}
    {{- end }}
{{ end -}}
{{ end }}
)

var (
{{- range $type := .Schema.Types }}
    {{- if not (eq $type.Kind "INPUT_OBJECT") }}
        {{- range $name, $field := $type.Fields }}
            {{- if eq $field.Kind "SCALAR" }}
    {{ $type.Name | capitalize }}Field{{ $name | capitalize | initialism }} {{ $type.Name | capitalize }}FieldScalar = "{{ $name }}"
            {{- end }}
        {{- end }}
    {{- end }}
{{- end }}
)

{{ range $type := .Schema.Types }}
{{- if not (eq $type.Kind "INPUT_OBJECT") }}
func (field {{ $type.Name | capitalize }}FieldScalar) {{ $type.Name | capitalize }}FieldGraphQL() string {
	return string(field)
}
{{ end }}
{{ end }}

{{- range $type := .Schema.Types }}
    {{ if not (eq $type.Kind "INPUT_OBJECT") }}
        {{- range $name, $field := $type.Fields }}
            {{- if eq $field.Kind "OBJECT" }}
func (fields {{ $type.Name }}Field{{ $name | capitalize }}) {{ $type.Name | capitalize }}FieldGraphQL() string {
    var s []string
    for _, field := range fields {
        s = append(s, field.{{ $field.Name }}FieldGraphQL())
    }
    return fmt.Sprintf("{{ $name }} { %s }", strings.Join(s, ", "))
}
            {{- end }}
        {{- end }}
    {{- end }}
{{- end }}

// New create new graphqlclient
func New(protoClient graphqlclient.ProtoClient) Client {
	return Client{
		protoClient: protoClient,
	}
}

{{ define "functionArguments" }}
    ctx context.Context,
    {{- range $name, $argument := .Arguments }}
    {{ $name }} {{ if $argument.List }}[]{{ end }}{{ if not $argument.NonNull }}*{{ end }}{{ $argument.Type }},
    {{- end }}
    {{- if ne .Type.Kind "SCALAR" }}
    fields {{ .Type.Name | capitalize }}Fields,
    {{- end }}
{{ end }}

{{ define "functionReturnValue" }}
{{- if .Type.List }}[]{{ end }}
{{- if not .Type.NonNull }}*{{ end }}
{{- if ne .Type.Kind "SCALAR" }}
    {{- .Type.Name }}
{{- else }}
    {{- .Type.Type }}
{{- end }}
{{- end }}

{{ define "operationArguments" }}
    {{- $first := true }}
    {{- range $name, $argument := . }}
        {{- if $first }}
            {{- $first = false }}
        {{- else }}
            ,
        {{- end -}}
        ${{ $name }}: {{ if $argument.List }}[{{ end }}{{ $argument.Name }}{{ if $argument.NonNull }}!{{ end }}{{ if $argument.List }}]{{ end }}{{ if $argument.ListNonNull }}!{{ end }}
    {{- end -}}
{{ end }}

{{ define "queryArguments" }}
    {{- $first := true }}
    {{- range $name, $argument := . }}
        {{- if $first }}
            {{- $first = false }}
        {{- else }}
            ,
        {{- end }}
        {{- $name }}: ${{ $name }}
    {{- end -}}
{{ end }}

{{- range $fun := .Schema.Functions }}
// {{ $fun.Name | capitalize }} ({{ $fun.QueryType }}) {{ stripPrefix $fun.Description $fun.Name }}
func (client Client) {{ $fun.Name | capitalize }}({{ template "functionArguments" $fun }}) ({{ template "functionReturnValue" $fun }}, error) {
    {{- if ne $fun.Type.Kind "SCALAR" }}
   	var s []string
	for _, field := range fields {
		s = append(s, field.{{ $fun.Type.Name | capitalize }}FieldGraphQL())
	}
	fieldsContent := fmt.Sprintf(" { %s }", strings.Join(s, ","))
    {{- else }}
	fieldsContent := ""
    {{- end }}

    body := graphqlclient.Body{
        Query: fmt.Sprintf(`
        {{ $fun.QueryType }} {{ with $fun.Arguments }}({{ template "operationArguments" . }}) {{ end }}{
            {{ $fun.Name }} {{- with $fun.Arguments }} ({{ template "queryArguments" . }}){{ end }}%s
        }`, fieldsContent),
        Variables: map[string]any{
{{- range $name, $argument := $fun.Arguments }}
            "{{ $name }}": {{ $name }},
{{- end }}
        },
    }

    var res graphqlclient.Response
    if err := client.protoClient.Do(ctx, body, &res); err != nil {
        {{- if and $fun.Type.NonNull (not $fun.Type.List)}}
            {{- if ne $fun.Type.Kind "SCALAR" }}
            return {{ $fun.Type.Name }}{}, err
            {{- else }}
            var placeholder {{ $fun.Type.Type }}
            return placeholder, err
            {{- end }}
        {{- else }}
        return nil, err
        {{- end }}
    }

    var data struct {
    {{ if $fun.Type.List }}
        {{- if ne $fun.Type.Kind "SCALAR" }}
            {{ $fun.Name | capitalize }} []{{ if not $fun.Type.NonNull }}*{{ end }}{{ $fun.Type.Name }} `json:"{{ $fun.Name }}"`
        {{- else }}
            {{ $fun.Name | capitalize }} []{{ if not $fun.Type.NonNull }}*{{ end }}{{ $fun.Type.Type }} `json:"{{ $fun.Name }}"`
        {{- end }}
    {{- else }}
        {{- if ne $fun.Type.Kind "SCALAR" }}
            {{ $fun.Name | capitalize }} {{ if not $fun.Type.NonNull }}*{{ end }}{{ $fun.Type.Name }} `json:"{{ $fun.Name }}"`
        {{- else }}
            {{ $fun.Name | capitalize }} {{ if not $fun.Type.NonNull }}*{{ end }}{{ $fun.Type.Type }} `json:"{{ $fun.Name }}"`
        {{- end }}
    {{- end }}
    }

    if res.Errors != nil {
        {{- if $fun.Type.NonNull }}
        return data.{{ $fun.Name | capitalize }}, *res.Errors
        {{- else }}
        return nil, *res.Errors
        {{- end }}
    }

	if err := json.Unmarshal(res.Data, &data); err != nil {
        {{- if $fun.Type.NonNull }}
        return data.{{ $fun.Name | capitalize }}, err
        {{- else }}
        return nil, err
        {{- end }}
	}

    return data.{{ $fun.Name | capitalize }}, nil
}
{{ end }}
